<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Facturas de Luz</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #374151;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #3b82f6;
            ring: 4px;
            ring-color: #93c5fd;
            outline: none;
        }
        .oculto {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-2">
            üí° Simulador de Factura El√©ctrica (Multi-Periodo) - v4
        </h1>

        <div id="auth-status" class="text-xs text-gray-500 mb-4 flex justify-between items-center">
            <span id="user-id-display">ID de Usuario: Cargando...</span>
            <span id="load-save-status" class="text-green-600"></span>
        </div>

        <!-- Secci√≥n de Perfiles y Carga/Guardado -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Guardar / Cargar Perfil</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <select id="profile-select" class="sm:w-1/2 input-group select">
                    <option value="">-- Seleccionar Perfil --</option>
                </select>
                <button onclick="loadProfile()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition duration-150">Cargar</button>
                <button onclick="saveProfile()" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150">Guardar</button>
            </div>
        </div>

        <!-- Formulario de Simulaci√≥n -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Columna de Datos de la Tarifa y Potencia -->
            <div class="space-y-6">
                <h2 class="text-xl font-semibold text-blue-700 border-b pb-2">1. Datos Fijos y Potencia (2 Periodos)</h2>

                <div class="input-group">
                    <label for="billing-days">D√≠as de Facturaci√≥n (D√≠as)</label>
                    <input type="number" id="billing-days" value="30" min="1" class="input-group input">
                </div>

                <!-- Alquiler de Contador -->
                <div class="input-group">
                    <!--label for="meter-rental-daily">Alquiler Contador (‚Ç¨/d√≠a)</label-->
                    <input type="number" id="meter-rental-daily" value="0.027" min="0" step="0.001" class="oculto">
                </div>
                
                <!-- Cuota Fija Adicional -->
                <div class="input-group">
                    <label for="fixed-monthly-fee">Cuota Fija Adicional (‚Ç¨/mes)</label>
                    <input type="number" id="fixed-monthly-fee" value="0.00" min="0" step="0.01" class="input-group input">
                </div>
                
                <h3 class="text-lg font-semibold text-gray-700 border-t pt-4">Potencia Contratada y Precio</h3>

                <!-- Potencia -->
                <div class="flex gap-4">
                    <div class="input-group w-1/2">
                        <label for="contracted-power-p1">Potencia P1 (Punta - kW)</label>
                        <input type="number" id="contracted-power-p1" value="3.45" min="0" step="0.1" class="input-group input">
                    </div>
                    <div class="input-group w-1/2">
                        <label for="contracted-power-p2">Potencia P2 (Valle - kW)</label>
                        <input type="number" id="contracted-power-p2" value="3.45" min="0" step="0.1" class="input-group input">
                    </div>
                    <input type="number" id="power-price-daily-p1" value="0.109589" min="0" step="0.000001" class="oculto">
                    <input type="number" id="power-price-daily-p2" value="0.024657" min="0" step="0.000001" class="oculto">
                </div>
            </div>

            <!-- Columna de Consumo y Precios -->
            <div class="space-y-6">
                <h2 class="text-xl font-semibold text-blue-700 border-b pb-2">2. Consumo y Precios (‚Ç¨/kWh) - 3 Periodos</h2>

                <div class="space-y-6">
                    <!-- Periodo P1 (Punta - Peak) -->
                    <div class="flex gap-4">
                        <div class="input-group w-1/2">
                            <label for="consumption-punta">Consumo P1 (Punta - kWh)</label>
                            <input type="number" id="consumption-punta" value="202.873" min="0" step="1" class="input-group input">
                        </div>
                        <div class="input-group w-1/2">
                            <!--label for="price-punta">Precio P1 (‚Ç¨/kWh)</label-->
                            <input type="number" id="price-punta" value="0.18" min="0" step="0.001" class="oculto">
                        </div>
                    </div>

                    <!-- Periodo P2 (Llano - Shoulder) -->
                    <div class="flex gap-4">
                        <div class="input-group w-1/2">
                            <label for="consumption-llano">Consumo P2 (Llano - kWh)</label>
                            <input type="number" id="consumption-llano" value="0" min="0" step="1" class="input-group input">
                        </div>
                        <div class="input-group w-1/2">
                            <!--label for="price-llano">Precio P2 (‚Ç¨/kWh)</label-->
                            <input type="number" id="price-llano" value="0.12" min="0" step="0.001" class="oculto">
                        </div>
                    </div>

                    <!-- Periodo P3 (Valle - Off-Peak) -->
                    <div class="flex gap-4">
                        <div class="input-group w-1/2">
                            <label for="consumption-valle">Consumo P3 (Valle - kWh)</label>
                            <input type="number" id="consumption-valle" value="0" min="0" step="1" class="input-group input">
                        </div>
                        <div class="input-group w-1/2">
                            <!--label for="price-valle">Precio P3 (‚Ç¨/kWh)</label-->
                            <input type="number" id="price-valle" value="0.08" min="0" step="0.001" class="oculto">
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 border-t pt-4">3. Descuentos e Impuestos</h3>
                
                <!-- Bono Social Descuento -->
                <div class="input-group">
                    <label for="social-bono-discount-rate">Bono Social / Descuento (%)</label>
                    <input type="number" id="social-bono-discount-rate" value="0" min="0" max="100" step="1" class="input-group input">
                </div>

                <!-- Financiaci√≥n Bono Social (Nuevo) -->
                <div class="input-group">
                    <!--label for="social-bono-financing-rate">Financiaci√≥n Bono Social</label-->
                    <input type="number" id="social-bono-financing-rate" value="0.0127" min="0" step="0.00001" class="oculto">
                </div>

                <div class="input-group">
                    <!--label for="electricity-tax-rate">Impuesto Electricidad (%)</label-->
                    <input type="number" id="electricity-tax-rate" value="5.113" min="0" step="0.001" class="oculto">
                </div>
                <div class="input-group">
                    <!--label for="vat-rate">IVA/IGIC (%)</label-->
                    <input type="number" id="vat-rate" value="21" min="0" step="0.1" class="oculto">
                </div>
            </div>
        </div>

        <button onclick="calculateBill()" class="w-full mt-8 py-3 bg-red-600 text-white text-lg font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-150 transform hover:scale-[1.01] active:scale-95">
            CALCULAR FACTURA SIMULADA
        </button>

        <!-- Resultados de la Simulaci√≥n -->
        <div id="results-section" class="mt-8 pt-6 border-t-2 border-dashed border-gray-300 hidden">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Resultado de la Simulaci√≥n</h2>

            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-md">
                <p class="text-2xl font-bold text-red-700">TOTAL ESTIMADO A PAGAR: <span id="total-bill-display">0.00 ‚Ç¨</span></p>
                <p class="text-sm text-red-600 mt-1">Estimaci√≥n para <span id="billing-days-summary">30</span> d√≠as de facturaci√≥n.</p>
            </div>

            <!-- Detalles de la Factura -->
            <div class="space-y-4">
                <div class="bg-gray-100 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">1. T√©rmino de Potencia (Fijo)</h3>
                    <div id="power-breakdown">
                        <!-- Desglose de potencia P1 y P2 -->
                    </div>
                    <div class="flex justify-between items-center text-lg font-bold border-t mt-2 pt-2">
                        <span class="text-gray-700">Subtotal Potencia:</span>
                        <span id="power-term-display" class="font-mono text-gray-800">0.00 ‚Ç¨</span>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">2. Otros Costes Fijos</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-lg">
                            <span class="text-gray-600">Alquiler Contador (<span id="rental-days-summary">30</span> Eur/d√≠a):</span>
                            <span id="meter-rental-display" class="font-mono font-bold text-gray-800">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center text-lg border-t pt-1">
                            <span class="text-gray-600">Cuota Fija Adicional (Prorrateada):</span>
                            <span id="fixed-fee-display" class="font-mono font-bold text-gray-800">0.00 ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">3. T√©rmino de Energ√≠a (Variable)</h3>
                    <div id="energy-breakdown">
                        <!-- Detalles de consumo por periodos se insertar√°n aqu√≠ -->
                    </div>
                    <div class="flex justify-between items-center text-lg font-bold border-t mt-2 pt-2">
                        <span class="text-gray-700">Subtotal Consumo (<span id="total-consumption-display">0</span> kWh):</span>
                        <span id="energy-term-display" class="font-mono text-gray-800">0.00 ‚Ç¨</span>
                    </div>
                </div>
                
                <!-- Secci√≥n de Descuentos -->
                <div class="bg-red-100 p-4 rounded-lg shadow border-2 border-red-300">
                    <h3 class="text-xl font-semibold text-red-700 mb-2">4. Descuentos Aplicados</h3>
                    <div class="flex justify-between items-center text-lg font-bold">
                        <span class="text-red-600">Bono Social Descuento (<span id="social-bono-rate-display">0</span>% sobre Base):</span>
                        <span id="social-bono-discount-display" class="font-mono text-red-700">-0.00 ‚Ç¨</span>
                    </div>
                </div>

                <!-- Secci√≥n de Cargos (Incluye Financiaci√≥n BS) -->
                <div class="bg-yellow-50 p-4 rounded-lg shadow border-2 border-yellow-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">5. Cargos Obligatorios e Impuestos</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-md font-bold text-blue-800">
                            <span class="text-blue-700">Financiaci√≥n Bono Social (<span id="financing-rate-display">0</span> ‚Ç¨/kWh):</span>
                            <span id="social-bono-financing-display" class="font-mono font-bold">0.00 ‚Ç¨</span>
                        </div>
                        <hr class="border-gray-300 my-1"/>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 font-bold">Base Imponible (Fijos + Energ√≠a + Financiaci√≥n - Descuento):</span>
                            <span id="base-imponible-display" class="font-mono font-medium">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Impuesto de Electricidad (<span id="elec-tax-rate-display">5.113</span>%):</span>
                            <span id="electricity-tax-display" class="font-mono font-medium">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center border-t mt-1 pt-1">
                            <span class="text-gray-600">Subtotal con Impuesto Electricidad:</span>
                            <span id="subtotal-tax-base-display" class="font-mono font-medium">0.00 ‚Ç¨</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">IVA/IGIC (<span id="vat-rate-display">21</span>%):</span>
                            <span id="vat-display" class="font-mono font-medium text-green-700">0.00 ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 text-white p-4 rounded-lg mt-4 shadow-xl">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold">TOTAL FACTURA (Impuestos Incluidos)</span>
                        <span id="total-bill-final-display" class="text-3xl font-extrabold font-mono">0.00 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        </div>

         <!-- Modal para mensajes/errores (NO USAR alert()) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Error</h3>
                <p id="modal-message" class="text-gray-700 mb-6">Mensaje de error.</p>
                <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Cerrar</button>
            </div>
        </div>
    </div>


    <script>
        // Definici√≥n de la URL del endpoint de Flask para obtener la lista de tarifas
        const API_URL_BASE = 'https://luz_facil.onrender.com/api/';
        const API_URL = API_URL_BASE + 'tarifas';
        const API_URL_PARAMS = API_URL_BASE + 'general_costs';

        /**
         * 1. Obtiene la lista de tarifas desde el endpoint de Flask.
         * 2. Rellena el elemento <select> con las opciones de tarifa.
         */
        async function loadTariffOptions() {
            const selectElement = document.getElementById('profile-select');

            // Mantenemos la opci√≥n por defecto (Seleccionar Perfil) y eliminamos cualquier otra
            selectElement.innerHTML = '<option value="">-- Seleccionar Perfil --</option>';

            try {
                // 1. Realizar la petici√≥n GET al endpoint de Flask
                const response = await fetch(API_URL);
                
                // Manejar errores HTTP (e.g., 404, 500)
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const tariffs = await response.json(); // Convertir la respuesta a JSON (es una lista)
                
                // 2. Iterar sobre la lista de tarifas y crear los <option>
                tariffs.forEach(tariff => {
                    // Creamos el elemento <option>
                    const option = document.createElement('option');
                    
                    // Valor (value): Usamos el ID (p. ej., END_ONE_001)
                    option.value = tariff.id; 
                    
                    // Texto visible: Usamos Company - Name (p. ej., Endesa - One Luz (3 Periodos Fijo))
                    option.textContent = `${tariff.company} - ${tariff.name}`;
                    
                    // A√±adir la opci√≥n al select
                    selectElement.appendChild(option);
                });

                console.log(`‚úÖ ${tariffs.length} tarifas cargadas en el select.`);

            } catch (error) {
                console.error('‚ùå Error al cargar las tarifas:', error);
                // Opcional: Mostrar un mensaje de error en la UI
                selectElement.innerHTML += '<option value="" disabled>Error al cargar las tarifas</option>';
            }

            try {
                // 1. Realizar la petici√≥n GET al endpoint de Flask
                const response = await fetch(API_URL_PARAMS);
                
                // Manejar errores HTTP (e.g., 404, 500)
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const params = await response.json(); // Convertir la respuesta a JSON (es una lista)
                                // Ejemplo de visualizaci√≥n de los datos de potencia en la consola:
                const p1 = params.iva_rate;
                const p3 = params.meter_rental_daily;
                
                console.log('--- Par√°metros  ---');
                console.log(`IVA: ${p1}`);
                console.log(`Impuesto energ√≠a: ${ params.electricity_tax_rate}`);
                console.log(`Alquiler contador por d√≠a: ${p3}`);
                console.log(`Financiaci√≥n bono social: ${params.social_bonus_financial}`);
                console.log('---------------------------------');

                console.log(`‚úÖ Par√°metros cargados correctamente.`);
                
                document.getElementById('vat-rate').value = params.iva_rate * 100;
                document.getElementById('electricity-tax-rate').value = params.electricity_tax_rate * 100;
                document.getElementById('meter-rental-daily').value = params.meter_rental_daily;
                document.getElementById('social-bono-financing-rate').value = params.social_bonus_financial;
                
                
                

            } catch (error) {
                console.error('‚ùå Error al cargar los par√°metrso:', error);
                // Opcional: Mostrar un mensaje de error en la UI
                selectElement.innerHTML += '<option value="" disabled>Error al cargar los par√°metros </option>';
            }            

        }

        /**
         * Obtiene el ID seleccionado en el men√∫ y llama al endpoint de Flask 
         * para obtener los detalles completos de esa tarifa.
         */
        async function loadProfile() {
            // 1. Obtener el ID seleccionado
            const selectElement = document.getElementById('profile-select');
            const selectedId = selectElement.value; 

            // 2. Verificar que se haya seleccionado algo
            if (!selectedId) {
                alert('Por favor, selecciona una tarifa para cargar.');
                return;
            }

            // 3. Construir la URL del endpoint din√°mico (ej: /tarifas/END_ONE_001)
            const detailURL = `${API_URL}/${selectedId}`;
            
            console.log(`üîé Petici√≥n a: ${detailURL}`);

            try {
                // 4. Realizar la petici√≥n GET
                const response = await fetch(detailURL);
                
                // Manejar respuesta no exitosa (ej: 404 Not Found, 500 Internal Server Error)
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error ${response.status}: ${errorData.message}`);
                }

                const data = await response.json(); // Data contiene {description, details}
                
                // 5. Procesar los datos cargados
                const tariffDetails = data.details;

                console.log(`‚úÖ Datos de la tarifa cargados exitosamente: ${data.description}`);
                
                // ‚≠êÔ∏è EJEMPLO DE USO DE LOS DATOS CARGADOS:
                // Aqu√≠ es donde usar√≠as los datos para llenar otros campos de tu formulario
                // (por ejemplo, los campos de potencia contratada, precios por kWh, etc.)
                
                // Ejemplo de visualizaci√≥n de los datos de potencia en la consola:
                console.log('--- Datos Clave de la Tarifa ---');
                console.log(`Potencia P1 diaria (‚Ç¨/kW¬∑d√≠a): ${tariffDetails.power_term.p1_price_kw_day.toFixed(5)}`);
                console.log(`Potencia P1 diaria (‚Ç¨/kW¬∑d√≠a): ${tariffDetails.power_term.p2_price_kw_day.toFixed(5)}`);
                console.log(`Energ√≠a P1 (Punta) (‚Ç¨/kWh): ${tariffDetails.energy_term.p1_price_kwh.toFixed(5)}`);
                console.log(`Energ√≠a P2 (Punta) (‚Ç¨/kWh): ${tariffDetails.energy_term.p2_price_kwh.toFixed(5)}`);
                console.log(`Energ√≠a P3 (Punta) (‚Ç¨/kWh): ${tariffDetails.energy_term.p3_price_kwh.toFixed(5)}`);
                console.log('---------------------------------');
                
                document.getElementById('power-price-daily-p1').value = tariffDetails.power_term.p1_price_kw_day.toFixed(5);
                document.getElementById('power-price-daily-p2').value = tariffDetails.power_term.p2_price_kw_day.toFixed(5);

                document.getElementById('price-punta').value = tariffDetails.energy_term.p1_price_kwh.toFixed(5);
                document.getElementById('price-llano').value = tariffDetails.energy_term.p2_price_kwh.toFixed(5);
                document.getElementById('price-valle').value = tariffDetails.energy_term.p3_price_kwh.toFixed(5);
                
            } catch (error) {
                console.error('‚ùå Error al obtener los detalles de la tarifa:', error);
                alert(`No se pudo cargar la tarifa: ${error.message}`);
            }
        }


        // 3. Llamar a la funci√≥n cuando la p√°gina est√© completamente cargada
        document.addEventListener('DOMContentLoaded', loadTariffOptions);        
        
        
        /**
         * Muestra el modal de mensajes/errores.
         * @param {string} title T√≠tulo del modal.
         * @param {string} message Mensaje a mostrar.
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        /**
         * Cierra el modal.
         */
        window.closeModal = function() {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        }

        /**
         * Realiza el c√°lculo completo de la factura.
         */
        window.calculateBill = function() {
            // 1. Recolecci√≥n de datos
            const billingDays = parseFloat(document.getElementById('billing-days').value);
            const meterRentalDaily = parseFloat(document.getElementById('meter-rental-daily').value);
            const fixedMonthlyFee = parseFloat(document.getElementById('fixed-monthly-fee').value); 

            // Potencia
            const contractedPowerP1 = parseFloat(document.getElementById('contracted-power-p1').value);
            const powerPriceDailyP1 = parseFloat(document.getElementById('power-price-daily-p1').value);
            const contractedPowerP2 = parseFloat(document.getElementById('contracted-power-p2').value);
            const powerPriceDailyP2 = parseFloat(document.getElementById('power-price-daily-p2').value);

            // Consumo y Precios
            const consumptionPunta = parseFloat(document.getElementById('consumption-punta').value);
            const pricePunta = parseFloat(document.getElementById('price-punta').value);
            const consumptionLlano = parseFloat(document.getElementById('consumption-llano').value);
            const priceLlano = parseFloat(document.getElementById('price-llano').value);
            const consumptionValle = parseFloat(document.getElementById('consumption-valle').value);
            const priceValle = parseFloat(document.getElementById('price-valle').value);

            // Descuentos, Cargos e Impuestos
            const socialBonoDiscountRate = parseFloat(document.getElementById('social-bono-discount-rate').value) / 100;
            const socialBonoFinancingRate = parseFloat(document.getElementById('social-bono-financing-rate').value); // Nuevo
            const electricityTaxRate = parseFloat(document.getElementById('electricity-tax-rate').value) / 100;
            const vatRate = parseFloat(document.getElementById('vat-rate').value) / 100;

            // Validaci√≥n b√°sica
            if (isNaN(billingDays) || billingDays <= 0 || isNaN(electricityTaxRate) || isNaN(vatRate)) {
                showModal('Error de Datos', 'Por favor, ingrese valores num√©ricos v√°lidos en los campos principales.');
                return;
            }

            // --- C√ÅLCULOS PRINCIPALES ---

            // 2. C√°lculo del T√©rmino de Potencia (Fijo - P1 y P2)
            const powerTermP1 = contractedPowerP1 * powerPriceDailyP1 * billingDays;
            const powerTermP2 = contractedPowerP2 * powerPriceDailyP2 * billingDays;
            const powerTerm = powerTermP1 + powerTermP2;

            let powerBreakdownHTML = `
                <div class="flex justify-between items-center text-sm text-red-600">
                    <span>P1 Punta (${contractedPowerP1.toFixed(2)} kW @ ${powerPriceDailyP1.toFixed(6)} ‚Ç¨/kW/d√≠a):</span>
                    <span class="font-mono font-medium">${powerTermP1.toFixed(2)} ‚Ç¨</span>
                </div>
                <div class="flex justify-between items-center text-sm text-green-600">
                    <span>P2 Valle (${contractedPowerP2.toFixed(2)} kW @ ${powerPriceDailyP2.toFixed(6)} ‚Ç¨/kW/d√≠a):</span>
                    <span class="font-mono font-medium">${powerTermP2.toFixed(2)} ‚Ç¨</span>
                </div>
            `;

            // 3. Otros Costes Fijos (Alquiler + Cuota Fija Adicional)
            const meterRentalTerm = meterRentalDaily * billingDays;
            const proratedFixedFee = fixedMonthlyFee * (billingDays / 30.42); // Prorrateo usando d√≠as del mes (aprox.)
            const fixedCharges = powerTerm + proratedFixedFee;

            // 4. C√°lculo del T√©rmino de Energ√≠a (Variable - P1, P2 y P3)
            const costPunta = consumptionPunta * pricePunta;
            const costLlano = consumptionLlano * priceLlano;
            const costValle = consumptionValle * priceValle;

            const energyTerm = costPunta + costLlano + costValle;
            const totalConsumption = consumptionPunta + consumptionLlano + consumptionValle;

            const energyBreakdownHTML = `
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between items-center text-red-600">
                        <span>P1 Punta (${consumptionPunta.toFixed(0)} kWh @ ${pricePunta.toFixed(3)} ‚Ç¨/kWh):</span>
                        <span class="font-mono font-medium">${costPunta.toFixed(2)} ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center text-orange-600">
                        <span>P2 Llano (${consumptionLlano.toFixed(0)} kWh @ ${priceLlano.toFixed(3)} ‚Ç¨/kWh):</span>
                        <span class="font-mono font-medium">${costLlano.toFixed(2)} ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center text-green-600">
                        <span>P3 Valle (${consumptionValle.toFixed(0)} kWh @ ${priceValle.toFixed(3)} ‚Ç¨/kWh):</span>
                        <span class="font-mono font-medium">${costValle.toFixed(2)} ‚Ç¨</span>
                    </div>
                </div>
            `;
            
            // 5. Coste de Financiaci√≥n del Bono Social (basado en d√≠as)
            const socialBonoFinancingCost = billingDays * socialBonoFinancingRate;

            // 6. Base para Descuento (Potencia + Otros Fijos + Energ√≠a + Financiaci√≥n BS)
            // Nota: En la pr√°ctica, el descuento (si aplica) puede ir solo sobre la energ√≠a, pero aqu√≠ se aplica sobre la base total para mayor generalidad.
            const baseForDiscount = fixedCharges + energyTerm + socialBonoFinancingCost;

            // 7. Descuento Bono Social (Se aplica a la Base para Descuento)
            const socialBonoDiscount = (fixedCharges + energyTerm) * socialBonoDiscountRate; // Se aplica sobre Potencia + Energ√≠a + Fijos, sin la financiaci√≥n BS (que es un cargo obligatorio)

            // 8. Base Imponible (Base - Descuento)
            const baseImponible = (fixedCharges + energyTerm + socialBonoFinancingCost) - socialBonoDiscount;

            // 9. Impuesto Electricidad (IE)
            const electricityTax = baseImponible * electricityTaxRate;
            const subtotalTaxBase = baseImponible + electricityTax + meterRentalTerm;

            // 10. IVA/IGIC
            const vat = subtotalTaxBase * vatRate;

            // 11. TOTAL
            const totalBill = subtotalTaxBase + vat;

            // --- ACTUALIZACI√ìN DE LA INTERFAZ ---
            document.getElementById('results-section').classList.remove('hidden');

            // Actualizaciones del resumen y totales
            document.getElementById('billing-days-summary').textContent = billingDays.toFixed(0);
            document.getElementById('rental-days-summary').textContent = billingDays.toFixed(0) + ' x ' + meterRentalDaily.toFixed(5);
            document.getElementById('total-consumption-display').textContent = totalConsumption.toFixed(0);
            document.getElementById('total-bill-display').textContent = totalBill.toFixed(2) + ' ‚Ç¨';
            document.getElementById('total-bill-final-display').textContent = totalBill.toFixed(2) + ' ‚Ç¨';

            // T√©rmino de Potencia
            document.getElementById('power-term-display').textContent = powerTerm.toFixed(2) + ' ‚Ç¨';
            document.getElementById('power-breakdown').innerHTML = powerBreakdownHTML;

            // Otros Costes Fijos
            document.getElementById('meter-rental-display').textContent = meterRentalTerm.toFixed(2) + ' ‚Ç¨';
            document.getElementById('fixed-fee-display').textContent = proratedFixedFee.toFixed(2) + ' ‚Ç¨';

            // T√©rmino de Energ√≠a
            document.getElementById('energy-term-display').textContent = energyTerm.toFixed(2) + ' ‚Ç¨';
            document.getElementById('energy-breakdown').innerHTML = energyBreakdownHTML;
            
            // Descuento Bono Social
            document.getElementById('social-bono-rate-display').textContent = (socialBonoDiscountRate * 100).toFixed(0);
            document.getElementById('social-bono-discount-display').textContent = '-' + socialBonoDiscount.toFixed(2) + ' ‚Ç¨';

            // Financiaci√≥n Bono Social (Cargo)
            document.getElementById('financing-rate-display').textContent = billingDays.toFixed(0) + ' x '  + socialBonoFinancingRate.toFixed(5);
            document.getElementById('social-bono-financing-display').textContent = socialBonoFinancingCost.toFixed(2) + ' ‚Ç¨';

            // Impuestos
            document.getElementById('elec-tax-rate-display').textContent = (electricityTaxRate * 100).toFixed(3);
            document.getElementById('vat-rate-display').textContent = (vatRate * 100).toFixed(1);
            document.getElementById('base-imponible-display').textContent = baseImponible.toFixed(2) + ' ‚Ç¨';
            document.getElementById('electricity-tax-display').textContent = electricityTax.toFixed(2) + ' ‚Ç¨';
            document.getElementById('subtotal-tax-base-display').textContent = subtotalTaxBase.toFixed(2) + ' ‚Ç¨';
            document.getElementById('vat-display').textContent = vat.toFixed(2) + ' ‚Ç¨';
        }
    </script>
</body>
</html>